package com.lucky.around.meal.exception;

import static com.lucky.around.meal.exception.exceptionType.CommonExceptionType.*;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.security.core.AuthenticationException;
import org.springframework.validation.BindingResult;
import org.springframework.validation.FieldError;
import org.springframework.web.HttpMediaTypeNotSupportedException;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.MissingServletRequestParameterException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.springframework.web.method.annotation.MethodArgumentTypeMismatchException;
import org.springframework.web.servlet.NoHandlerFoundException;

import com.lucky.around.meal.exception.exceptionType.SecurityExceptionType;

import io.jsonwebtoken.ExpiredJwtException;
import io.jsonwebtoken.MalformedJwtException;
import io.jsonwebtoken.UnsupportedJwtException;
import lombok.extern.slf4j.Slf4j;

@RestControllerAdvice
@Slf4j
public class CustomExceptionHandler {
  @ExceptionHandler(CustomException.class)
  public ResponseEntity<String> handleCustomException(CustomException ex) {
    return ResponseEntity.status(ex.getExceptionType().status()).body(ex.getMessage());
  }

  @ExceptionHandler(RuntimeException.class)
  public ResponseEntity<String> handleServerException(RuntimeException ex) {
    log.error("üö® InternalException occurred: {} üö®", ex.getMessage(), ex);
    return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
        .body(INTERNAL_SERVER_ERROR.getMessage());
  }

  @ExceptionHandler(NoHandlerFoundException.class)
  public ResponseEntity<String> handleNotFoundException(NoHandlerFoundException ex) {
    return ResponseEntity.status(HttpStatus.NOT_FOUND)
        .body(NOT_FOUND_PATH.getMessage() + ": " + ex.getRequestURL());
  }

  @ExceptionHandler(MethodArgumentNotValidException.class)
  public ResponseEntity<String> handleValidationError(MethodArgumentNotValidException ex) {
    BindingResult bindingResult = ex.getBindingResult();
    StringBuilder builder = new StringBuilder();

    if (bindingResult.hasErrors()) {
      for (FieldError fieldError : bindingResult.getFieldErrors()) {
        builder
            .append("[")
            .append(fieldError.getField())
            .append("](ÏùÄ)Îäî ")
            .append(fieldError.getDefaultMessage())
            .append(" ÏûÖÎ†•Îêú Í∞í: [")
            .append(fieldError.getRejectedValue())
            .append("] ");
      }
    }

    return ResponseEntity.status(HttpStatus.BAD_REQUEST)
        .body(INVALID_INPUT_VALUE.getMessage() + ": " + builder);
  }

  @ExceptionHandler(MethodArgumentTypeMismatchException.class)
  public ResponseEntity<String> handleMethodArgumentTypeMismatchException(
      MethodArgumentTypeMismatchException ex) {
    return ResponseEntity.status(HttpStatus.BAD_REQUEST)
        .body(
            INVALID_REQUEST_PARAM_TYPE.getMessage() + ": " + ex.getParameter().getParameterName());
  }

  @ExceptionHandler(MissingServletRequestParameterException.class)
  public ResponseEntity<String> handleMissingServletRequestParameterException(
      MissingServletRequestParameterException ex) {
    return ResponseEntity.status(HttpStatus.BAD_REQUEST)
        .body(NOT_NULL_REQUEST_PARAM.getMessage() + ": " + ex.getParameterName());
  }

  @ExceptionHandler(HttpMediaTypeNotSupportedException.class)
  public ResponseEntity<String> handleHttpMediaTypeNotSupportedException() {
    return ResponseEntity.status(HttpStatus.UNSUPPORTED_MEDIA_TYPE)
        .body(INVALID_JSON_TYPE.getMessage());
  }

  // Spring Security Ïù∏Ï¶ù, Ïù∏Í∞Ä Í¥ÄÎ†® ÏòàÏô∏ Ï≤òÎ¶¨
  @ExceptionHandler(AuthenticationException.class)
  public ResponseEntity<String> handleAuthenticationException(AuthenticationException ex) {
    return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
        .body(SecurityExceptionType.REQUIRED_AUTHENTICATION.getMessage());
  }

  // jwt ÌòïÏãù Ïò§Î•ò
  @ExceptionHandler(MalformedJwtException.class)
  public ResponseEntity<String> handleMalformedJwtException(MalformedJwtException ex) {
    return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
        .body(SecurityExceptionType.INVALID_JWT_TOKEN.getMessage());
  }

  // jwt ÌòïÏãù Ïò§Î•ò
  @ExceptionHandler(SecurityException.class)
  public ResponseEntity<String> handleSecurityException(SecurityException ex) {
    return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
        .body(SecurityExceptionType.INVALID_JWT_TOKEN.getMessage());
  }

  // jwt ÏÑúÎ™Ö Ïò§Î•ò
  @ExceptionHandler(ExpiredJwtException.class)
  public ResponseEntity<String> handleExpiredJwtException(ExpiredJwtException ex) {
    return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
        .body(SecurityExceptionType.EXPIRED_JWT_TOKEN.getMessage());
  }

  // ÏßÄÏõêÎêòÏßÄ ÏïäÎäî jwt
  @ExceptionHandler(UnsupportedJwtException.class)
  public ResponseEntity<String> handleUnsupportedJwtException(UnsupportedJwtException ex) {
    return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
        .body(SecurityExceptionType.UNSUPPORTED_JWT_TOKEN.getMessage());
  }

  // jwt ÌÅ¥Î†àÏûÑ ÎπÑÏñ¥ÏûàÏùå Ïò§Î•ò
  @ExceptionHandler(IllegalArgumentException.class)
  public ResponseEntity<String> handleIllegalArgumentException(IllegalArgumentException ex) {
    return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
        .body(SecurityExceptionType.EMPTY_JWT_CLAIMS.getMessage());
  }

  // Spring Security Í∂åÌïú Í¥ÄÎ†® ÏòàÏô∏ Ï≤òÎ¶¨
  @ExceptionHandler(AccessDeniedException.class)
  public ResponseEntity<String> handleAccessDeniedException(AccessDeniedException ex) {
    return ResponseEntity.status(HttpStatus.FORBIDDEN).body(ex.getMessage());
  }
}
